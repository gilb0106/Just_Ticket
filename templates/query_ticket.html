<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ticket Query</title>
</head>
<body>
    <h2>Ticket Query</h2>
<form id="queryForm" action="{{ url_for('query_tickets') }}" method="post">
    <label for="state">State:</label>
    <select name="state" id="state">
        <option value="">All</option>
        <option value="open">Open</option>
        <option value="inprogress">In Progress</option>
        <option value="closed">Closed</option>
    </select><br><br>
    <label for="created_date">Created Date:</label>
    <input type="date" id="created_date" name="created_date"><br><br>
    <label for="modified_date">Modified Date:</label>
    <input type="date" id="modified_date" name="modified_date"><br><br>
    <button type="submit">Query</button>
</form>
    <button type="button" id="exportBtn" style="display: none;">Export CSV</button>
    <div id="ticketData"></div>

    <script>
        document.getElementById('queryForm').addEventListener('submit', function(event) {
            event.preventDefault();
            fetch('/query_tickets', {
                method: 'POST',
                body: new FormData(document.getElementById('queryForm')),
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('ticketData').innerHTML = data;
                // Show export button if there are tickets
                if (data.trim() !== "No tickets found matching the criteria.") {
                    document.getElementById('exportBtn').style.display = 'inline-block';
                } else {
                    document.getElementById('exportBtn').style.display = 'none';
                }
            });
        });

        document.getElementById('exportBtn').addEventListener('click', function() {
            // Get the table element
            var table = document.getElementById('ticketTable');

            // Initialize empty CSV string
            var csv = '';

            // Loop through rows
            for (var i = 0; i < table.rows.length; i++) {
                var row = table.rows[i];
                // Loop through cells
                for (var j = 0; j < row.cells.length; j++) {
                    // Append cell value to CSV with comma separator
                    csv += '"' + row.cells[j].innerText.replace(/"/g, '""') + '",';
                }
                // Add newline after each row
                csv += '\n';
            }

            // Create Blob object containing the CSV data
            var blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });

            // Create temporary link with Blob URL
            var link = document.createElement('a');
            if (link.download !== undefined) { // Feature detection
                var url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', 'tickets.csv');
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            } else {
                alert('Your browser does not support automatic download. Please right-click the link and select "Save link as" to download the file.');
            }
        });
    </script>
</body>
</html>
